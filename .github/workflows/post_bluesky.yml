      - name: Post to Bluesky
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_APP_PASSWORD: ${{ secrets.BSKY_APP_PASSWORD }}
        run: |
          python << 'EOF'
          import os
          import httpx
          from atproto import Client

          handle = os.environ["BSKY_HANDLE"]
          password = os.environ["BSKY_APP_PASSWORD"]

          # ===============================
          # ★ タイムアウト 60秒 + リトライ3回
          # ===============================
          transport = httpx.HTTPTransport(retries=3)
          session = httpx.Client(timeout=60, transport=transport)

          # ★ atproto.Client に session を注入
          client = Client(session=session)
          client.login(handle, password)

          text = """${{ github.event.inputs.post_text }}"""

          image_path = "slide.png"
          print("Posting image:", image_path)
          print("Text:\n", text)

          with open(image_path, "rb") as f:
              img_bytes = f.read()

          client.send_image(
              text=text,
              image=img_bytes,
              image_alt="Market chart"
          )

          print("✓ Posted to Bluesky!")
          EOF
