name: Post to Bluesky

on:
  workflow_dispatch:
    inputs:
      post_text:
        description: "Text to post on Bluesky"
        required: true
      image_file:
        description: "PNG file name (ex: etf_exported_slide.png)"
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ======================================================
      # ① Google Drive から PNG をダウンロード
      # ======================================================
      - name: Install Drive client
        run: pip install google-api-python-client google-auth

      - name: Download slide PNG from Google Drive
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python download_from_drive.py \
            --name "${{ github.event.inputs.image_file }}" \
            --output "slide.png"

      # ======================================================
      # ② Bluesky へ投稿（★タイムアウト修正済）
      # ======================================================
      - name: Install Bluesky library
        run: pip install atproto

      - name: Post to Bluesky
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_APP_PASSWORD: ${{ secrets.BSKY_APP_PASSWORD }}
        run: |
          python << 'EOF'
          import os
          from atproto import Client

          handle = os.environ["BSKY_HANDLE"]
          password = os.environ["BSKY_APP_PASSWORD"]

          # ★ タイムアウト増強（ここが最重要）
          client = Client(timeout=60)
          client.login(handle, password)

          text = """${{ github.event.inputs.post_text }}"""

          image_path = "slide.png"
          print("Posting image:", image_path)
          print("Text:\n", text)

          with open(image_path, "rb") as f:
              img_bytes = f.read()

          client.send_image(
              text=text,
              image=img_bytes,
              image_alt="Market chart"
          )

          print("✓ Posted to Bluesky!")
          EOF
