name: Post to Bluesky

on:
  workflow_dispatch:
    inputs:
      post_text:
        description: "Text to post on Bluesky"
        required: true
      image_path:
        description: "Path to image file"
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Bluesky library
        run: pip install atproto

      - name: Post to Bluesky
        run: |
          python << 'EOF'
          import os
          from atproto import Client

          handle = os.environ["BSKY_HANDLE"]
          password = os.environ["BSKY_APP_PASSWORD"]

          client = Client()
          client.login(handle, password)

          text = "${{ github.event.inputs.post_text }}"
          image_path = "${{ github.event.inputs.image_path }}"

          with open(image_path, "rb") as f:
              img_bytes = f.read()

          client.send_image(
              text=text,
              image=img_bytes,
              image_alt="Market chart"
          )

          print("Posted to Bluesky.")
          EOF
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_APP_PASSWORD: ${{ secrets.BSKY_APP_PASSWORD }}
