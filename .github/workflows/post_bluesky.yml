      - name: Post to Bluesky
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_APP_PASSWORD: ${{ secrets.BSKY_APP_PASSWORD }}
        run: |
          python << 'EOF'
          import os
          import time
          from atproto import Client

          handle = os.environ["BSKY_HANDLE"]
          password = os.environ["BSKY_APP_PASSWORD"]

          text = """${{ github.event.inputs.post_text }}"""

          image_path = "slide.png"
          print("Posting image:", image_path)
          print("Text:\n", text)

          with open(image_path, "rb") as f:
              img_bytes = f.read()

          # ===============================
          # ★ ログイン & 投稿を最大3回リトライ
          # ===============================
          last_error = None
          for attempt in range(1, 4):
              try:
                  print(f"[Bluesky] Attempt {attempt}/3: login & post...")
                  client = Client()
                  client.login(handle, password)

                  client.send_image(
                      text=text,
                      image=img_bytes,
                      image_alt="Market chart",
                  )

                  print("✓ Posted to Bluesky!")
                  break

              except Exception as e:
                  last_error = e
                  print(f"[Bluesky] Attempt {attempt} failed: {e}")
                  if attempt < 3:
                      print("...wait 5 seconds and retry")
                      time.sleep(5)
                  else:
                      print("[Bluesky] All retries failed.")
                      raise

          EOF
