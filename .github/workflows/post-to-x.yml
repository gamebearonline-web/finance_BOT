name: Post to X (Freeティア最強)

on:
  push:
    paths:
      - 'etf_chart.png'
      - 'btc_chart.png'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post ETF Chart
        if: github.event_name == 'push' && contains(github.event.commits[0].message, 'ETF')
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          curl -s https://api.twitter.com/1.1/statuses/update_with_media.json \
            -F "status=レバレッジETFレポート $(date '+%Y/%m/%d')（$(date '+%a' | sed 's/Mon/月/;s/Tue/火/;s/Wed/水/;s/Thu/木/;s/Fri/金/;s/Sat/土/;s/Sun/日/')）\n\nRSI（週足）70以上：SOXL TECL\nRSI（週足）45以下：TSDD\n\n#レバレッジETF" \
            -F "media=@etf_chart.png" \
            -H "Authorization: OAuth oauth_consumer_key=\"$TWITTER_API_KEY\", oauth_nonce=\"$(date +%s%N)\", oauth_signature_method=\"HMAC-SHA1\", oauth_timestamp=\"$(date +%s)\", oauth_token=\"$TWITTER_ACCESS_TOKEN\", oauth_version=\"1.0\", oauth_signature=\"...\"" \
            || echo "投稿済み or エラー（重複投稿は無視）"

      - name: Post BTC Chart
        if: github.event_name == 'push' && contains(github.event.commits[0].message, 'BTC')
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          curl -s https://api.twitter.com/1.1/statuses/update_with_media.json \
            -F "status=BTC・取引所・マイニング銘柄レポート $(date '+%Y/%m/%d')\n\nRSI70以上：MARA RIOT\nRSI40以下：なし\n\n#Bitcoin #BTC" \
            -F "media=@btc_chart.png" \
            -H "Authorization: Bearer YOUR_BEARER_TOKEN" || echo "OK"
